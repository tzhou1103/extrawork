package com.nio.util;

import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;

import org.apache.commons.codec.binary.Base64;
import org.apache.log4j.Logger;

public class Base64Util {
	
	private static Logger logger = MyLoggerFactory.getLogger(Base64Util.class);

	public static void main(String[] args) {
		// test
		String fileStr = "cGFja2FnZSBjb20ubmlvLnV0aWw7DQoNCmltcG9ydCBqYXZhLmlvLkZpbGU7DQppbXBvcnQgamF2YS5pby5JT0V4Y2VwdGlvbjsNCmltcG9ydCBqYXZhLm1hdGguQmlnSW50ZWdlcjsNCmltcG9ydCBqYXZhLnV0aWwuSXRlcmF0b3I7DQppbXBvcnQgamF2YS51dGlsLk1hcDsNCmltcG9ydCBqYXZhLnV0aWwuUHJvcGVydGllczsNCmltcG9ydCBqYXZhLnV0aWwuVmVjdG9yOw0KaW1wb3J0IGphdmEudXRpbC5NYXAuRW50cnk7DQoNCmltcG9ydCBvcmcuYXBhY2hlLmxvZzRqLkxvZ2dlcjsNCmltcG9ydCBvcmcuYXBhY2hlLmxvZzRqLlByb3BlcnR5Q29uZmlndXJhdG9yOw0KDQppbXBvcnQgY29tLnRlYW1jZW50ZXIuY2xpZW50eC5BcHBYU2Vzc2lvbjsNCmltcG9ydCBjb20udGVhbWNlbnRlci5zZXJ2aWNlcy5zdHJvbmcuY29yZS5fMjAwNl8wMy5EYXRhTWFuYWdlbWVudC5JdGVtUHJvcGVydGllczsNCmltcG9ydCBjb20udGVhbWNlbnRlci5zZXJ2aWNlcy5zdHJvbmcuY29yZS5fMjAwNl8wMy5EYXRhTWFuYWdlbWVudC5HZW5lcmF0ZUl0ZW1JZHNBbmRJbml0aWFsUmV2aXNpb25JZHNQcm9wZXJ0aWVzOw0KaW1wb3J0IGNvbS50ZWFtY2VudGVyLnNjaGVtYXMuc29hLl8yMDA2XzAzLmV4Y2VwdGlvbnMuU2VydmljZUV4Y2VwdGlvbjsNCmltcG9ydCBjb20udGVhbWNlbnRlci5zZXJ2aWNlcy5sb29zZS5jb3JlLl8yMDA2XzAzLkZpbGVNYW5hZ2VtZW50LkRhdGFzZXRGaWxlSW5mbzsNCmltcG9ydCBjb20udGVhbWNlbnRlci5zZXJ2aWNlcy5sb29zZS5jb3JlLl8yMDA2XzAzLkZpbGVNYW5hZ2VtZW50LkdldERhdGFzZXRXcml0ZVRpY2tldHNJbnB1dERhdGE7DQppbXBvcnQgY29tLnRlYW1jZW50ZXIuc2VydmljZXMuc3Ryb25nLmNvcmUuRGF0YU1hbmFnZW1lbnRTZXJ2aWNlOw0KaW1wb3J0IGNvbS50ZWFtY2VudGVyLnNlcnZpY2VzLnN0cm9uZy5jb3JlLl8yMDA2XzAzLkRhdGFNYW5hZ2VtZW50LkNyZWF0ZURhdGFzZXRzUmVzcG9uc2U7DQppbXBvcnQgY29tLnRlYW1jZW50ZXIuc2VydmljZXMuc3Ryb25nLmNvcmUuXzIwMDZfMDMuRGF0YU1hbmFnZW1lbnQuQ3JlYXRlSXRlbXNPdXRwdXQ7DQppbXBvcnQgY29tLnRlYW1jZW50ZXIuc2VydmljZXMuc3Ryb25nLmNvcmUuXzIwMDZfMDMuRGF0YU1hbmFnZW1lbnQuQ3JlYXRlSXRlbXNSZXNwb25zZTsNCmltcG9ydCBjb20udGVhbWNlbnRlci5zZXJ2aWNlcy5zdHJvbmcuY29yZS5fMjAwNl8wMy5EYXRhTWFuYWdlbWVudC5DcmVhdGVSZWxhdGlvbnNSZXNwb25zZTsNCmltcG9ydCBjb20udGVhbWNlbnRlci5zZXJ2aWNlcy5zdHJvbmcuY29yZS5fMjAwNl8wMy5EYXRhTWFuYWdlbWVudC5EYXRhc2V0UHJvcGVydGllczsNCmltcG9ydCBjb20udGVhbWNlbnRlci5zZXJ2aWNlcy5zdHJvbmcuY29yZS5fMjAwNl8wMy5EYXRhTWFuYWdlbWVudC5HZW5lcmF0ZUl0ZW1JZHNBbmRJbml0aWFsUmV2aXNpb25JZHNSZXNwb25zZTsNCmltcG9ydCBjb20udGVhbWNlbnRlci5zZXJ2aWNlcy5zdHJvbmcuY29yZS5fMjAwNl8wMy5EYXRhTWFuYWdlbWVudC5JdGVtSWRzQW5kSW5pdGlhbFJldmlzaW9uSWRzOw0KaW1wb3J0IGNvbS50ZWFtY2VudGVyLnNlcnZpY2VzLnN0cm9uZy5jb3JlLl8yMDA2XzAzLkRhdGFNYW5hZ2VtZW50LlJlbGF0aW9uc2hpcDsNCmltcG9ydCBjb20udGVhbWNlbnRlci5zZXJ2aWNlcy5zdHJvbmcuY29yZS5fMjAwNl8wMy5EYXRhTWFuYWdlbWVudC5SZXZpc2lvbklkczsNCmltcG9ydCBjb20udGVhbWNlbnRlci5zZXJ2aWNlcy5zdHJvbmcuY29yZS5fMjAwN18wMS5EYXRhTWFuYWdlbWVudC5XaGVyZVJlZmVyZW5jZWRJbmZvOw0KaW1wb3J0IGNvbS50ZWFtY2VudGVyLnNlcnZpY2VzLnN0cm9uZy5jb3JlLl8yMDA3XzAxLkRhdGFNYW5hZ2VtZW50LldoZXJlUmVmZXJlbmNlZE91dHB1dDsNCmltcG9ydCBjb20udGVhbWNlbnRlci5zZXJ2aWNlcy5zdHJvbmcuY29yZS5fMjAwN18wMS5EYXRhTWFuYWdlbWVudC5XaGVyZVJlZmVyZW5jZWRSZXNwb25zZTsNCmltcG9ydCBjb20udGVhbWNlbnRlci5zZXJ2aWNlcy5zdHJvbmcuY29yZS5fMjAwN18wOS5EYXRhTWFuYWdlbWVudC5SZW1vdmVOYW1lZFJlZmVyZW5jZUZyb21EYXRhc2V0SW5mbzsNCmltcG9ydCBjb20udGVhbWNlbnRlci5zZXJ2aWNlcy5zdHJvbmcuY29yZS5fMjAwOF8wNi5EYXRhTWFuYWdlbWVudC5SZXZpc2VPdXRwdXQ7DQppbXBvcnQgY29tLnRlYW1jZW50ZXIuc2VydmljZXMuc3Ryb25nLmNvcmUuXzIwMTNfMDUuRGF0YU1hbmFnZW1lbnQuR2V0Q2hpbGRyZW5JbnB1dERhdGE7DQppbXBvcnQgY29tLnRlYW1jZW50ZXIuc2VydmljZXMuc3Ryb25nLmNvcmUuXzIwMTNfMDUuRGF0YU1hbmFnZW1lbnQuR2V0Q2hpbGRyZW5PdXRwdXQ7DQppbXBvcnQgY29tLnRlYW1jZW50ZXIuc2VydmljZXMuc3Ryb25nLmNvcmUuXzIwMTNfMDUuRGF0YU1hbmFnZW1lbnQuR2V0Q2hpbGRyZW5SZXNwb25zZTsNCmltcG9ydCBjb20udGVhbWNlbnRlci5zZXJ2aWNlcy5zdHJvbmcucXVlcnkuU2F2ZWRRdWVyeVNlcnZpY2U7DQppbXBvcnQgY29tLnRlYW1jZW50ZXIuc2VydmljZXMuc3Ryb25nLnF1ZXJ5Ll8yMDA2XzAzLlNhdmVkUXVlcnkuRGVzY3JpYmVTYXZlZFF1ZXJpZXNSZXNwb25zZTsNCmltcG9ydCBjb20udGVhbWNlbnRlci5zZXJ2aWNlcy5zdHJvbmcucXVlcnkuXzIwMDZfMDMuU2F2ZWRRdWVyeS5HZXRTYXZlZFF1ZXJpZXNSZXNwb25zZTsNCmltcG9ydCBjb20udGVhbWNlbnRlci5zZXJ2aWNlcy5zdHJvbmcucXVlcnkuXzIwMDZfMDMuU2F2ZWRRdWVyeS5TYXZlZFF1ZXJ5RmllbGRMaXN0T2JqZWN0Ow0KaW1wb3J0IGNvbS50ZWFtY2VudGVyLnNlcnZpY2VzLnN0cm9uZy5xdWVyeS5fMjAwNl8wMy5TYXZlZFF1ZXJ5LlNhdmVkUXVlcnlGaWVsZE9iamVjdDsNCmltcG9ydCBjb20udGVhbWNlbnRlci5zZXJ2aWNlcy5zdHJvbmcucXVlcnkuXzIwMDdfMDYuU2F2ZWRRdWVyeS5FeGVjdXRlU2F2ZWRRdWVyaWVzUmVzcG9uc2U7DQppbXBvcnQgY29tLnRlYW1jZW50ZXIuc2VydmljZXMuc3Ryb25nLnF1ZXJ5Ll8yMDA3XzA2LlNhdmVkUXVlcnkuU2F2ZWRRdWVyeUlucHV0Ow0KaW1wb3J0IGNvbS50ZWFtY2VudGVyLnNlcnZpY2VzLnN0cm9uZy5xdWVyeS5fMjAwN18wNi5TYXZlZFF1ZXJ5LlNhdmVkUXVlcnlSZXN1bHRzOw0KaW1wb3J0IGNvbS50ZWFtY2VudGVyLnNvYS5jbGllbnQuRmlsZU1hbmFnZW1lbnRVdGlsaXR5Ow0KaW1wb3J0IGNvbS50ZWFtY2VudGVyLnNvYS5jbGllbnQubW9kZWwuRXJyb3JTdGFjazsNCmltcG9ydCBjb20udGVhbWNlbnRlci5zb2EuY2xpZW50Lm1vZGVsLk1vZGVsT2JqZWN0Ow0KaW1wb3J0IGNvbS50ZWFtY2VudGVyLnNvYS5jbGllbnQubW9kZWwuU2VydmljZURhdGE7DQppbXBvcnQgY29tLnRlYW1jZW50ZXIuc29hLmNsaWVudC5tb2RlbC5zdHJvbmcuRGF0YXNldDsNCmltcG9ydCBjb20udGVhbWNlbnRlci5zb2EuY2xpZW50Lm1vZGVsLnN0cm9uZy5FUE1UYXNrOw0KaW1wb3J0IGNvbS50ZWFtY2VudGVyLnNvYS5jbGllbnQubW9kZWwuc3Ryb25nLkltYW5RdWVyeTsNCmltcG9ydCBjb20udGVhbWNlbnRlci5zb2EuY2xpZW50Lm1vZGVsLnN0cm9uZy5JdGVtOw0KaW1wb3J0IGNvbS50ZWFtY2VudGVyLnNvYS5jbGllbnQubW9kZWwuc3Ryb25nLkl0ZW1SZXZpc2lvbjsNCmltcG9ydCBjb20udGVhbWNlbnRlci5zb2EuY2xpZW50Lm1vZGVsLnN0cm9uZy5Vc2VyOw0KaW1wb3J0IGNvbS50ZWFtY2VudGVyLnNvYS5jbGllbnQubW9kZWwuc3Ryb25nLldvcmtzcGFjZU9iamVjdDsNCmltcG9ydCBjb20udGVhbWNlbnRlci5zb2EuZXhjZXB0aW9ucy5Ob3RMb2FkZWRFeGNlcHRpb247DQppbXBvcnQgY29tLnRlYW1jZW50ZXIuc2VydmljZXMuc3Ryb25nLmNvcmUuXzIwMDdfMDkuRGF0YU1hbmFnZW1lbnQuTmFtZWRSZWZlcmVuY2VJbmZvOw0KaW1wb3J0IGNvbS50ZWFtY2VudGVyLnNlcnZpY2VzLnN0cm9uZy53b3JrZmxvdy5Xb3JrZmxvd1NlcnZpY2U7DQppbXBvcnQgY29tLnRlYW1jZW50ZXIuc2VydmljZXMuc3Ryb25nLndvcmtmbG93Ll8yMDA3XzA2LldvcmtmbG93LlJlbGVhc2VTdGF0dXNJbnB1dDsNCmltcG9ydCBjb20udGVhbWNlbnRlci5zZXJ2aWNlcy5zdHJvbmcud29ya2Zsb3cuXzIwMDdfMDYuV29ya2Zsb3cuUmVsZWFzZVN0YXR1c09wdGlvbjsNCmltcG9ydCBjb20udGVhbWNlbnRlci5zZXJ2aWNlcy5zdHJvbmcud29ya2Zsb3cuXzIwMDdfMDYuV29ya2Zsb3cuU2V0UmVsZWFzZVN0YXR1c1Jlc3BvbnNlOw0KDQpwdWJsaWMgY2xhc3MgTXlTT0FVdGlsIA0Kew0KCXByaXZhdGUgc3RhdGljIGZpbmFsIExvZ2dlciBsb2dnZXIgPSBNeUxvZ2dlckZhY3RvcnkuZ2V0TG9nZ2VyKE15U09BVXRpbC5jbGFzcyk7DQoJcHJpdmF0ZSBzdGF0aWMgVXNlciB1c2VyID0gbnVsbDsNCgkNCglwdWJsaWMgc3RhdGljIFVzZXIgbG9naW4oKQ0KCXsNCgkJaWYgKHVzZXIgPT0gbnVsbCkNCgkJew0KCQkJUHJvcGVydGllcyBwcm9wZXJ0aWVzID0gbmV3IFByb3BlcnRpZXMoKTsNCgkJCXRyeSANCgkJCXsNCgkJCQlwcm9wZXJ0aWVzLmxvYWQoTXlMb2dnZXJGYWN0b3J5LmNsYXNzLmdldENsYXNzTG9hZGVyKCkuZ2V0UmVzb3VyY2VBc1N0cmVhbSgidGMucHJvcGVydGllcyIpKTsNCgkJCQlpZiAocHJvcGVydGllcyAhPSBudWxsKQ0KCQkJCQlQcm9wZXJ0eUNvbmZpZ3VyYXRvci5jb25maWd1cmUocHJvcGVydGllcyk7DQoJCQkJDQoJCQl9IGNhdGNoIChJT0V4Y2VwdGlvbiBlKSANCgkJCXsNCgkJCQllLnByaW50U3RhY2tUcmFjZSgpOw0KCQkJfQ0KCQkJDQoJCQlTdHJpbmcgdXJsID0gcHJvcGVydGllcy5nZXRQcm9wZXJ0eSgiVGNVcmwiKTsNCgkJCVN0cmluZyB1c2VyTmFtZSA9IHByb3BlcnRpZXMuZ2V0UHJvcGVydHkoIlRjVXNlck5hbWUiKTsNCgkJCVN0cmluZyBwYXNzd29yZCA9IHByb3BlcnRpZXMuZ2V0UHJvcGVydHkoIlRjUGFzc3dvcmQiKTsNCgkJCQ0KCQkJU3lzdGVtLm91dC5wcmludGxuKCI+Pj4gbG9naW5pbmcgd2l0aCB1c2VyOiIgKyB1c2VyTmFtZSk7DQoJCQlBcHBYU2Vzc2lvbiBzZXNzaW9uID0gbmV3IEFwcFhTZXNzaW9uKHVybCk7DQoJCQl1c2VyID0gc2Vzc2lvbi5sb2dpbih1c2VyTmFtZSwgcGFzc3dvcmQpOw0KCQl9IGVsc2Ugew0KCQkJRGF0YU1hbmFnZW1lbnRTZXJ2aWNlIGRtU2VydmljZSA9IERhdGFNYW5hZ2VtZW50U2VydmljZS5nZXRTZXJ2aWNlKEFwcFhTZXNzaW9uLmdldENvbm5lY3Rpb24oKSk7DQoJCQlkbVNlcnZpY2UuZ2V0UHJvcGVydGllcyhuZXcgTW9kZWxPYmplY3RbXSB7IHVzZXIgfSwJbmV3IFN0cmluZ1tdIHsgInVzZXJfaWQiIH0pOw0KCQkJdHJ5IHsNCgkJCQlTeXN0ZW0ub3V0LnByaW50bG4oIj4+PiBhbGVhcmR5IGxvZ2luZWQgd2l0aCB1c2VyICIgKyB1c2VyLmdldF91c2VyX2lkKCkpOw0KCQkJfSBjYXRjaCAoTm90TG9hZGVkRXhjZXB0aW9uIGUpIHsNCgkJCQllLnByaW50U3RhY2tUcmFjZSgpOw0KCQkJfQ0KCQl9DQoJCXJldHVybiB1c2VyOw0KCX0NCgkNCgkvKioNCgkgKiCy6dXSwePX6bz+DQoJICogDQoJICogQHBhcmFtIGl0ZW1faWQNCgkgKiBAcmV0dXJuDQoJICovDQoJcHVibGljIHN0YXRpYyBmaW5hbCBJdGVtIGZpbmRJdGVtKFN0cmluZyBpdGVtX2lkKQ0KCXsNCgkJTW9kZWxPYmplY3RbXSBtb2RlbE9iamVjdHMgPSBNeVNPQVV0aWwucXVlcnkoIkl0ZW0gSUQiLCBuZXcgU3RyaW5nW10geyAiSXRlbSBJRCIgfSwgbmV3IFN0cmluZ1tdIHsgaXRlbV9pZCB9KTsNCgkJaWYgKG1vZGVsT2JqZWN0cyAhPSBudWxsICYmIG1vZGVsT2JqZWN0cy5sZW5ndGggPiAwKQ0KCQkJcmV0dXJuIChJdGVtKSBtb2RlbE9iamVjdHNbMF07DQoJCXJldHVybiBudWxsOw0KCX0NCgkNCgkvKioNCgkgKiC78cihwePX6bz+1+7QwrDmsb4NCgkgKiANCgkgKiBAcGFyYW0gaXRlbQ0KCSAqIEByZXR1cm4NCgkgKiBAdGhyb3dzIE5vdExvYWRlZEV4Y2VwdGlvbg0KCSAqLw0KCXB1YmxpYyBzdGF0aWMgZmluYWwgSXRlbVJldmlzaW9uIGdldExhdGVzdEl0ZW1SZXYoSXRlbSBpdGVtKSB0aHJvd3MgTm90TG9hZGVkRXhjZXB0aW9uDQoJew0KCQlEYXRhTWFuYWdlbWVudFNlcnZpY2UgZG1TZXJ2aWNlID0gRGF0YU1hbmFnZW1lbnRTZXJ2aWNlLmdldFNlcnZpY2UoQXBwWFNlc3Npb24uZ2V0Q29ubmVjdGlvbigpKTsNCgkJZG1TZXJ2aWNlLmdldFByb3BlcnRpZXMobmV3IE1vZGVsT2JqZWN0W10geyBpdGVtIH0sCW5ldyBTdHJpbmdbXSB7ICJyZXZpc2lvbl9saXN0IiB9KTsNCgkJTW9kZWxPYmplY3RbXSByZXZpc2lvbl9saXN0ID0gaXRlbS5nZXRfcmV2aXNpb25fbGlzdCgpOw0KCQlpZiAocmV2aXNpb25fbGlzdCAhPSBudWxsICYmIHJldmlzaW9uX2xpc3QubGVuZ3RoID4gMCkgDQoJCQlyZXR1cm4gKEl0ZW1SZXZpc2lvbikgcmV2aXNpb25fbGlzdFtyZXZpc2lvbl9saXN0Lmxlbmd0aCAtIDFdOw0KCQlyZXR1cm4gbnVsbDsNCgl9DQoJDQoJLyoqDQoJICogu/HIocHj1+m8/tfu0MKw5rG+DQoJICogDQoJICogQHBhcmFtIGl0ZW0NCgkgKiBAcmV0dXJuDQoJICogQHRocm93cyBOb3RMb2FkZWRFeGNlcHRpb24NCgkgKi8NCglwdWJsaWMgc3RhdGljIGZpbmFsIEl0ZW1SZXZpc2lvbiBnZXRDUkFBUmV2KEl0ZW0gY3JJdGVtKSB0aHJvd3MgTm90TG9hZGVkRXhjZXB0aW9uDQoJew0KCQlJdGVtUmV2aXNpb24gY3JBQVJldiA9IG51bGw7DQoJCURhdGFNYW5hZ2VtZW50U2VydmljZSBkbVNlcnZpY2UgPSBEYXRhTWFuYWdlbWVudFNlcnZpY2UuZ2V0U2VydmljZShBcHBYU2Vzc2lvbi5nZXRDb25uZWN0aW9uKCkpOw0KCQlkbVNlcnZpY2UuZ2V0UHJvcGVydGllcyhuZXcgTW9kZWxPYmplY3RbXSB7IGNySXRlbSB9LAluZXcgU3RyaW5nW10geyAicmV2aXNpb25fbGlzdCIgfSk7DQoJCU1vZGVsT2JqZWN0W10gcmV2aXNpb25fbGlzdCA9IGNySXRlbS5nZXRfcmV2aXNpb25fbGlzdCgpOw0KCQlpZiAocmV2aXNpb25fbGlzdCAhPSBudWxsICYmIHJldmlzaW9uX2xpc3QubGVuZ3RoID4gMCkgDQoJCXsNCgkJCWZvciAoTW9kZWxPYmplY3QgbW9kZWxPYmplY3QgOiByZXZpc2lvbl9saXN0KSANCgkJCXsNCgkJCQlJdGVtUmV2aXNpb24gaXRlbVJldmlzaW9uID0gKEl0ZW1SZXZpc2lvbikgbW9kZWxPYmplY3Q7DQoJCQkJZG1TZXJ2aWNlLmdldFByb3BlcnRpZXMobmV3IE1vZGVsT2JqZWN0W10geyBpdGVtUmV2aXNpb24gfSwgbmV3IFN0cmluZ1tdIHsgIml0ZW1fcmV2aXNpb25faWQiIH0pOw0KCQkJCVN0cmluZyBpdGVtX3JldmlzaW9uX2lkID0gaXRlbVJldmlzaW9uLmdldF9pdGVtX3JldmlzaW9uX2lkKCk7DQoJCQkJaWYgKGl0ZW1fcmV2aXNpb25faWQuZXF1YWxzKCJBQSIpKSB7DQoJCQkJCWNyQUFSZXYgPSBpdGVtUmV2aXNpb247DQoJCQkJCWJyZWFrOw0KCQkJCX0NCgkJCX0NCgkJCWlmIChjckFBUmV2ID09IG51bGwpIHsNCgkJCQljckFBUmV2ID0gKEl0ZW1SZXZpc2lvbikgcmV2aXNpb25fbGlzdFtyZXZpc2lvbl9saXN0Lmxlbmd0aCAtIDFdOw0KCQkJfQ0KCQl9DQoJCXJldHVybiBjckFBUmV2Ow0KCX0NCg0KCS8qKg0KCSAqILX308PPtc2zsunRrw0KCSAqIA0KCSAqIEBwYXJhbSBxdWVyeU5hbWUNCgkgKiBAcGFyYW0ga2V5cw0KCSAqIEBwYXJhbSB2YWx1ZXMNCgkgKiBAcmV0dXJuDQoJICovDQoJcHVibGljIHN0YXRpYyBmaW5hbCBNb2RlbE9iamVjdFtdIHF1ZXJ5KFN0cmluZyBxdWVyeU5hbWUsIFN0cmluZ1tdIGtleXMsIFN0cmluZ1tdIHZhbHVlcykgDQoJew0KCQlJbWFuUXVlcnkgcXVlcnkgPSBudWxsOw0KDQoJCVNhdmVkUXVlcnlTZXJ2aWNlIHF1ZXJ5U2VydmljZSA9IFNhdmVkUXVlcnlTZXJ2aWNlLmdldFNlcnZpY2UoQXBwWFNlc3Npb24uZ2V0Q29ubmVjdGlvbigpKTsNCgkJdHJ5IA0KCQl7DQoJCQlHZXRTYXZlZFF1ZXJpZXNSZXNwb25zZSBzYXZlZFF1ZXJpZXMgPSBxdWVyeVNlcnZpY2UuZ2V0U2F2ZWRRdWVyaWVzKCk7DQoNCgkJCWlmIChzYXZlZFF1ZXJpZXMucXVlcmllcy5sZW5ndGggPT0gMCkgDQoJCQl7DQoJCQkJU3lzdGVtLm91dC5wcmludGxuKCJUaGVyZSBhcmUgbm8gc2F2ZWQgcXVlcmllcyBpbiB0aGUgc3lzdGVtLiIpOw0KICAgICAgICAgICAgCWxvZ2dlci5lcnJvcigiVGhlcmUgYXJlIG5vIHNhdmVkIHF1ZXJpZXMgaW4gdGhlIHN5c3RlbS4iKTsNCgkJCQlyZXR1cm4gbnVsbDsNCgkJCX0NCg0KCQkJZm9yIChpbnQgaSA9IDA7IGkgPCBzYXZlZFF1ZXJpZXMucXVlcmllcy5sZW5ndGg7IGkrKykgDQoJCQl7DQoJCQkJaWYgKHNhdmVkUXVlcmllcy5xdWVyaWVzW2ldLm5hbWUuZXF1YWxzKHF1ZXJ5TmFtZSkpIA0KCQkJCXsNCgkJCQkJcXVlcnkgPSBzYXZlZFF1ZXJpZXMucXVlcmllc1tpXS5xdWVyeTsNCgkJCQkJYnJlYWs7DQoJCQkJfQ0KCQkJfQ0KCQl9IGNhdGNoIChTZXJ2aWNlRXhjZXB0aW9uIGUpIHsNCgkJCVN5c3RlbS5vdXQucHJpbnRsbigiR2V0U2F2ZWRRdWVyaWVzIHNlcnZpY2UgcmVxdWVzdCBmYWlsZWQuIik7DQoJCQlTeXN0ZW0ub3V0LnByaW50bG4oZS5nZXRNZXNzYWdlKCkpOw0KCQkJbG9nZ2VyLmVycm9yKCJHZXRTYXZlZFF1ZXJpZXMgc2VydmljZSByZXF1ZXN0IGZhaWxlZC4iKTsNCiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihlLmdldE1lc3NhZ2UoKSk7DQoJCQlyZXR1cm4gbnVsbDsNCgkJfQ0KDQoJCWlmIChxdWVyeSA9PSBudWxsKSB7DQoJCQlTeXN0ZW0ub3V0LnByaW50bG4oIlRoZXJlIGlzIG5vdCBhbiAiICsgcXVlcnlOYW1lICsgIiBxdWVyeS4iKTsNCgkJCWxvZ2dlci5lcnJvcigiVGhlcmUgaXMgbm90IGFuICIgKyBxdWVyeU5hbWUgKyAiIHF1ZXJ5LiIpOw0KCQkJcmV0dXJuIG51bGw7DQoJCX0NCg0KCQl0cnkgew0KCQkJVmVjdG9yPFN0cmluZz4gbmV3S2V5cyA9IG5ldyBWZWN0b3I8U3RyaW5nPigpOw0KCQkJRGVzY3JpYmVTYXZlZFF1ZXJpZXNSZXNwb25zZSBkZXNjID0gcXVlcnlTZXJ2aWNlLmRlc2NyaWJlU2F2ZWRRdWVyaWVzKG5ldyBJbWFuUXVlcnlbXSB7cXVlcnl9KTsNCgkJCVNhdmVkUXVlcnlGaWVsZExpc3RPYmplY3QgZmllbGRMaXN0cyA9IGRlc2MuZmllbGRMaXN0c1swXTsNCgkJCVNhdmVkUXVlcnlGaWVsZE9iamVjdFtdIGZpZWxkcyA9IGZpZWxkTGlzdHMuZmllbGRzOw0KCQkJDQoJCQlmb3IgKGludCBpID0gMDsgaSA8IGtleXMubGVuZ3RoOyBpKyspIA0KCQkJew0KCQkJCVN0cmluZyBrZXkgPSBrZXlzW2ldOw0KCQkJCVN0cmluZyBuZXdLZXkgPSBrZXk7DQoJCQkJZm9yIChpbnQgaiA9IDA7IGogPCBmaWVsZHMubGVuZ3RoOyBqKyspIA0KCQkJCXsNCgkJCQkJU2F2ZWRRdWVyeUZpZWxkT2JqZWN0IGZpZWxkID0gZmllbGRzW2pdOw0KCQkJCQlpZiAoZmllbGQuYXR0cmlidXRlTmFtZS5lcXVhbHMoa2V5KSkNCgkJCQkJew0KCQkJCQkJbmV3S2V5ID0gZmllbGQuZW50cnlOYW1lOw0KCQkJCQkJU3lzdGVtLm91dC5wcmludGxuKCJpbmZvOiIgKyBuZXdLZXkpOw0KCQkJCQl9DQoJCQkJfQ0KCQkJCW5ld0tleXMuYWRkKG5ld0tleSk7DQoJCQl9DQoJCQkNCgkJCVNhdmVkUXVlcnlJbnB1dFtdIHNhdmVkUXVlcnlJbnB1dCA9IG5ldyBTYXZlZFF1ZXJ5SW5wdXRbMV07DQoJCQlzYXZlZFF1ZXJ5SW5wdXRbMF0gPSBuZXcgU2F2ZWRRdWVyeUlucHV0KCk7DQoJCQlzYXZlZFF1ZXJ5SW5wdXRbMF0ucXVlcnkgPSBxdWVyeTsNCgkJCXNhdmVkUXVlcnlJbnB1dFswXS5tYXhOdW1Ub1JldHVybiA9IDI1Ow0KCQkJc2F2ZWRRdWVyeUlucHV0WzBdLmxpbWl0TGlzdENvdW50ID0gMDsNCgkJCXNhdmVkUXVlcnlJbnB1dFswXS5saW1pdExpc3QgPSBuZXcgTW9kZWxPYmplY3RbMF07DQoJCQlzYXZlZFF1ZXJ5SW5wdXRbMF0uZW50cmllcyA9IG5ld0tleXMudG9BcnJheShuZXcgU3RyaW5nW25ld0tleXMuc2l6ZSgpXSk7DQoJCQlzYXZlZFF1ZXJ5SW5wdXRbMF0udmFsdWVzID0gdmFsdWVzOw0KCQkJc2F2ZWRRdWVyeUlucHV0WzBdLm1heE51bVRvSW5mbGF0ZSA9IDI1Ow0KDQoJCQlFeGVjdXRlU2F2ZWRRdWVyaWVzUmVzcG9uc2Ugc2F2ZWRRdWVyeVJlc3VsdCA9IHF1ZXJ5U2VydmljZS5leGVjdXRlU2F2ZWRRdWVyaWVzKHNhdmVkUXVlcnlJbnB1dCk7DQoJCQlTYXZlZFF1ZXJ5UmVzdWx0cyBmb3VuZCA9IHNhdmVkUXVlcnlSZXN1bHQuYXJyYXlPZlJlc3VsdHNbMF07DQoJCQkNCgkJCXJldHVybiBmb3VuZC5vYmplY3RzOw0KCQl9IGNhdGNoIChFeGNlcHRpb24gZSkgew0KCQkJU3lzdGVtLm91dC5wcmludGxuKCJFeGVjdXRlU2F2ZWRRdWVyeSBzZXJ2aWNlIHJlcXVlc3QgZmFpbGVkLiIpOw0KCQkJU3lzdGVtLm91dC5wcmludGxuKGUuZ2V0TWVzc2FnZSgpKTsNCgkJCWxvZ2dlci5lcnJvcigiRXhlY3V0ZVNhdmVkUXVlcnkgc2VydmljZSByZXF1ZXN0IGZhaWxlZC4iKTsNCiAgICAgICAgICAgIGxvZ2dlci5lcnJvcihlLmdldE1lc3NhZ2UoKSk7DQoJCX0NCgkJcmV0dXJuIG51bGw7DQoJfQ0KCQ0KICAgIC8qKg0KICAgICAqINDetqnB49fpvP4NCiAgICAgKiANCiAgICAgKiBAcGFyYW0gaXRlbQ0KICAgICAqIEBwYXJhbSBsYXRlc3RSZXYNCiAgICAgKiBAcGFyYW0gcmV2SURQcmVmaXgNCiAgICAgKiBAcmV0dXJuDQogICAgICogQHRocm93cyBTZXJ2aWNlRXhjZXB0aW9uDQogICAgICogQHRocm93cyBOb3RMb2FkZWRFeGNlcHRpb24NCiAgICAgKi8NCiAgICBwdWJsaWMgc3RhdGljIEl0ZW1SZXZpc2lvbiByZXZpc2VJdGVtKEl0ZW0gaXRlbSwgSXRlbVJldmlzaW9uIGxhdGVzdFJldiwgU3RyaW5nIHJldklEUHJlZml4KSB0aHJvd3MgU2VydmljZUV4Y2VwdGlvbiwgTm90TG9hZGVkRXhjZXB0aW9uDQogICAgew0KICAgIAlEYXRhTWFuYWdlbWVudCBkYXRhTWFuYWdlbWVudCA9IG5ldyBEYXRhTWFuYWdlbWVudCgpOw0KICAgIAlNYXA8QmlnSW50ZWdlciwgUmV2aXNpb25JZHM+IGdlbmVyYXRlUmV2aXNpb25JZHMgPSBkYXRhTWFuYWdlbWVudC5nZW5lcmF0ZVJldmlzaW9uSWRzKG5ldyBJdGVtW10geyBpdGVtIH0pOw0KCQlTdHJpbmdbXSByZXZJRFByZWZpeEFycmF5ID0geyByZXZJRFByZWZpeCB9Ow0KCQlNYXA8U3RyaW5nLCBSZXZpc2VPdXRwdXQ+IHJldmlzZUl0ZW1zID0gZGF0YU1hbmFnZW1lbnQucmV2aXNlSXRlbXMoZ2VuZXJhdGVSZXZpc2lvbklkcywgbmV3IEl0ZW1SZXZpc2lvbltdIHsgbGF0ZXN0UmV2IH0sIHJldklEUHJlZml4QXJyYXkpOw0KCQlpZiAocmV2aXNlSXRlbXMgIT0gbnVsbCAmJiByZXZpc2VJdGVtcy5zaXplKCkgPiAwKSANCgkJew0KCQkJSXRlcmF0b3I8RW50cnk8U3RyaW5nLCBSZXZpc2VPdXRwdXQ+PiBpdGVyYXRvciA9IHJldmlzZUl0ZW1zLmVudHJ5U2V0KCkuaXRlcmF0b3IoKTsNCgkJCXdoaWxlIChpdGVyYXRvci5oYXNOZXh0KCkpIA0KCQkJew0KCQkJCUVudHJ5PFN0cmluZywgUmV2aXNlT3V0cHV0PiBlbnRyeSA9IGl0ZXJhdG9yLm5leHQoKTsNCgkJCQlyZXR1cm4gZW50cnkuZ2V0VmFsdWUoKS5uZXdJdGVtUmV2Ow0KCQkJfQ0KCQl9DQoJCXJldHVybiBudWxsOw0KICAgIH0NCiAgICANCgkvKioNCgkgKiC4+b7d1ri2qLnYz7W78cihudjBqrbUz/MNCgkgKiANCgkgKiBAcGFyYW0gb2JqZWN0DQoJICogQHBhcmFtIHJlbGF0aW9uDQoJICogQHJldHVybg0KCSAqIEB0aHJvd3MgRXhjZXB0aW9uDQoJICovDQoJcHVibGljIHN0YXRpYyBNb2RlbE9iamVjdFtdIGdldFJlbGF0ZWRPYmplY3RzKE1vZGVsT2JqZWN0IG9iamVjdCwgU3RyaW5nIHJlbGF0aW9uKSB0aHJvd3MgRXhjZXB0aW9uDQoJew0KCQlEYXRhTWFuYWdlbWVudFNlcnZpY2UgZG1TZXJ2aWNlID0gRGF0YU1hbmFnZW1lbnRTZXJ2aWNlLmdldFNlcnZpY2UoQXBwWFNlc3Npb24uZ2V0Q29ubmVjdGlvbigpKTsNCgkJZG1TZXJ2aWNlLmdldFByb3BlcnRpZXMobmV3IE1vZGVsT2JqZWN0W10geyBvYmplY3QgfSwgbmV3IFN0cmluZ1tdIHsgcmVsYXRpb24gfSk7DQoJCU1vZGVsT2JqZWN0W10gbW9kZWxPYmplY3RzID0gb2JqZWN0LmdldFByb3BlcnR5T2JqZWN0KHJlbGF0aW9uKS5nZXRNb2RlbE9iamVjdEFycmF5VmFsdWUoKTsNCgkJcmV0dXJuIG1vZGVsT2JqZWN0czsNCgl9DQoJDQoJcHVibGljIHN0YXRpYyBib29sZWFuIGlzQ29udGFpbihNb2RlbE9iamVjdFtdIG1vZGVsT2JqZWN0cywgTW9kZWxPYmplY3Qgb2JqMikNCgl7DQoJCWZvciAoTW9kZWxPYmplY3QgbW9kZWxPYmplY3QgOiBtb2RlbE9iamVjdHMpIHsNCgkJCWlmIChtb2RlbE9iamVjdCA9PSBvYmoyKSB7DQoJCQkJU3lzdGVtLm91dC5wcmludGxuKCI+Pj4gY29udGFpbi4iKTsNCgkJCQlyZXR1cm4gdHJ1ZTsNCgkJCX0NCgkJfQ0KCQlyZXR1cm4gZmFsc2U7DQoJfQ0KCQ0KCS8qKg0KCSAqILj5vt252M+1udjBqrbUz/MNCgkgKiANCgkgKiBAcGFyYW0gb2JqMQ0KCSAqIEBwYXJhbSBvYmoyDQoJICogQHBhcmFtIHJlbGF0aW9uVHlwZQ0KCSAqIEB0aHJvd3MgRXhjZXB0aW9uDQoJICovDQoJcHVibGljIHN0YXRpYyB2b2lkIGNyZWF0ZVJlbGF0aW9uKE1vZGVsT2JqZWN0IG9iajEsIE1vZGVsT2JqZWN0IG9iajIsIFN0cmluZyByZWxhdGlvblR5cGUpIHRocm93cyBFeGNlcHRpb24gDQoJew0KCQlEYXRhTWFuYWdlbWVudFNlcnZpY2UgZG1TZXJ2aWNlID0gRGF0YU1hbmFnZW1lbnRTZXJ2aWNlLmdldFNlcnZpY2UoQXBwWFNlc3Npb24uZ2V0Q29ubmVjdGlvbigpKTsNCg0KCQlSZWxhdGlvbnNoaXAgcmVsYXRpb25zaGlwID0gbmV3IFJlbGF0aW9uc2hpcCgpOw0KCQlyZWxhdGlvbnNoaXAucHJpbWFyeU9iamVjdCA9IG9iajE7DQoJCXJlbGF0aW9uc2hpcC5zZWNvbmRhcnlPYmplY3QgPSBvYmoyOw0KCQlyZWxhdGlvbnNoaXAucmVsYXRpb25UeXBlID0gcmVsYXRpb25UeXBlOw0KDQoJCUNyZWF0ZVJlbGF0aW9uc1Jlc3BvbnNlIHJlc3BvbnNlID0gZG1TZXJ2aWNlLmNyZWF0ZVJlbGF0aW9ucyhuZXcgUmVsYXRpb25zaGlwW10geyByZWxhdGlvbnNoaXAgfSk7DQoNCgkJaWYgKHJlc3BvbnNlLnNlcnZpY2VEYXRhLnNpemVPZlBhcnRpYWxFcnJvcnMoKSA+IDApIHsNCgkJCXRocm93IG5ldyBFeGNlcHRpb24oYnVpbGRFcnJvck1lc3NhZ2UocmVzcG9uc2Uuc2VydmljZURhdGEpKTsNCgkJfQ0KCX0NCgkNCgkvKioNCgkgKiC4+LbUz/PU9rzT17TMrA0KCSAqIA0KCSAqIEBwYXJhbSB3c28NCgkgKiBAcGFyYW0gc3RhdHVzDQoJICogQHRocm93cyBFeGNlcHRpb24NCgkgKi8NCglwdWJsaWMgc3RhdGljIHZvaWQgYWRkU3RhdHVzKFdvcmtzcGFjZU9iamVjdCB3c28sIFN0cmluZyBzdGF0dXMpIHRocm93cyBFeGNlcHRpb24NCgl7DQoJCVdvcmtmbG93U2VydmljZSB3ZlNydiA9IFdvcmtmbG93U2VydmljZS5nZXRTZXJ2aWNlKEFwcFhTZXNzaW9uLmdldENvbm5lY3Rpb24oKSk7DQoJCVJlbGVhc2VTdGF0dXNJbnB1dFtdIHJzSW5wdXQgPSBuZXcgUmVsZWFzZVN0YXR1c0lucHV0W10geyBuZXcgUmVsZWFzZVN0YXR1c0lucHV0KCkgfTsNCgkJcnNJbnB1dFswXS5vYmplY3RzID0gbmV3IFdvcmtzcGFjZU9iamVjdFtdIHsgd3NvIH07DQoJCXJzSW5wdXRbMF0ub3BlcmF0aW9ucyA9IG5ldyBSZWxlYXNlU3RhdHVzT3B0aW9uW10geyBuZXcgUmVsZWFzZVN0YXR1c09wdGlvbigpIH07DQoJCXJzSW5wdXRbMF0ub3BlcmF0aW9uc1swXS5vcGVyYXRpb24gPSAiQXBwZW5kIjsNCgkJcnNJbnB1dFswXS5vcGVyYXRpb25zWzBdLm5ld1JlbGVhc2VTdGF0dXNUeXBlTmFtZSA9IHN0YXR1czsNCgkJU2V0UmVsZWFzZVN0YXR1c1Jlc3BvbnNlIHJlc3BvbnNlID0gd2ZTcnYuc2V0UmVsZWFzZVN0YXR1cyhyc0lucHV0KTsNCgkJaWYgKHJlc3BvbnNlLnNlcnZpY2VEYXRhLnNpemVPZlBhcnRpYWxFcnJvcnMoKSA+IDApIHsNCgkJCXRocm93IG5ldyBFeGNlcHRpb24oTXlTT0FVdGlsLmJ1aWxkRXJyb3JNZXNzYWdlKHJlc3BvbnNlLnNlcnZpY2VEYXRhKSk7DQoJCX0NCgl9DQoJDQoJLyoqDQoJICogu/HIobbUz/PL+dTawfezzA0KCSAqIA0KCSAqIEBwYXJhbSB3c28NCgkgKiBAcmV0dXJuDQoJICogQHRocm93cyBFeGNlcHRpb24NCgkgKi8NCglwdWJsaWMgc3RhdGljIEVQTVRhc2sgZ2V0RVBNVGFzayhXb3Jrc3BhY2VPYmplY3Qgd3NvKSB0aHJvd3MgRXhjZXB0aW9uDQoJew0KCQlFUE1UYXNrIGVwbVRhc2sgPSBudWxsOw0KCQlEYXRhTWFuYWdlbWVudFNlcnZpY2UgZG1TZXJ2aWNlID0gRGF0YU1hbmFnZW1lbnRTZXJ2aWNlLmdldFNlcnZpY2UoQXBwWFNlc3Npb24uZ2V0Q29ubmVjdGlvbigpKTsNCgkJV2hlcmVSZWZlcmVuY2VkUmVzcG9uc2UgcmVzcG9uc2UgPSBkbVNlcnZpY2Uud2hlcmVSZWZlcmVuY2VkKG5ldyBXb3Jrc3BhY2VPYmplY3RbXSB7IHdzbyB9LCAxKTsNCgkJaWYgKHJlc3BvbnNlLnNlcnZpY2VEYXRhLnNpemVPZlBhcnRpYWxFcnJvcnMoKSA+IDApDQoJCQl0aHJvdyBuZXcgRXhjZXB0aW9uKGJ1aWxkRXJyb3JNZXNzYWdlKHJlc3BvbnNlLnNlcnZpY2VEYXRhKSk7DQoJCVdoZXJlUmVmZXJlbmNlZE91dHB1dFtdIG91dHB1dHMgPSByZXNwb25zZS5vdXRwdXQ7DQoJCWZvciAoaW50IGogPSAwOyBqIDwgb3V0cHV0cy5sZW5ndGg7IGorKykgDQoJCXsNCgkJCVdoZXJlUmVmZXJlbmNlZEluZm9bXSBpbmZvcyA9IG91dHB1dHNbal0uaW5mbzsNCgkJCWZvciAoV2hlcmVSZWZlcmVuY2VkSW5mbyBpbmZvIDogaW5mb3MpIA0KCQkJew0KCQkJCVdvcmtzcGFjZU9iamVjdCByZWZlcmVuY2UgPSBpbmZvLnJlZmVyZW5jZXI7DQoJCQkJaWYgKHJlZmVyZW5jZS5nZXRUeXBlT2JqZWN0KCkuaXNJbnN0YW5jZU9mKCJFUE1UYXNrIikpIHsNCgkJCQkJZXBtVGFzayA9IChFUE1UYXNrKSByZWZlcmVuY2U7DQoJCQkJCWJyZWFrOw0KCQkJCX0NCgkJCX0NCgkJfQ0KCQkNCgkJcmV0dXJuIGVwbVRhc2s7DQoJfQ0KCQ0KCS8qKg0KCSAqIMXQts+21M/zyse38beisrwNCgkgKiANCgkgKiBAcGFyYW0gbGF0ZXN0UmV2DQoJICogQHJldHVybg0KCSAqLw0KCXB1YmxpYyBzdGF0aWMgYm9vbGVhbiBpc09iamVjdFJlbGVhc2VkKE1vZGVsT2JqZWN0IGxhdGVzdFJldikNCgl7DQoJCXRyeQ0KCQl7DQoJCQlEYXRhTWFuYWdlbWVudFNlcnZpY2UgZG1TZXJ2aWNlID0gRGF0YU1hbmFnZW1lbnRTZXJ2aWNlLmdldFNlcnZpY2UoQXBwWFNlc3Npb24uZ2V0Q29ubmVjdGlvbigpKTsNCgkJCWRtU2VydmljZS5nZXRQcm9wZXJ0aWVzKG5ldyBNb2RlbE9iamVjdFtdIHsgbGF0ZXN0UmV2IH0sIG5ldyBTdHJpbmdbXSB7ICJyZWxlYXNlX3N0YXR1c19saXN0IiB9KTsNCgkJCU1vZGVsT2JqZWN0W10gc3RhdHVzZXMgPSBsYXRlc3RSZXYuZ2V0UHJvcGVydHlPYmplY3QoInJlbGVhc2Vfc3RhdHVzX2xpc3QiKS5nZXRNb2RlbE9iamVjdEFycmF5VmFsdWUoKTsNCgkJCWlmIChzdGF0dXNlcyAhPSBudWxsICYmIHN0YXR1c2VzLmxlbmd0aCA+IDApIHsNCgkJCQlyZXR1cm4gdHJ1ZTsNCgkJCX0NCgkJfSBjYXRjaCAoTm90TG9hZGVkRXhjZXB0aW9uIGUpIHsNCgkJCWUucHJpbnRTdGFja1RyYWNlKCk7DQoJCX0NCgkJcmV0dXJuIGZhbHNlOw0KCX0NCgkNCgkvKioNCgkgKiC0tL2oyv2+3byvDQoJICogDQoJICogQHBhcmFtIGRzTmFtZQ0KCSAqIEBwYXJhbSBkc1R5cGUNCgkgKiBAcmV0dXJuDQoJICovDQoJQFN1cHByZXNzV2FybmluZ3MoImRlcHJlY2F0aW9uIikNCglwdWJsaWMgc3RhdGljIERhdGFzZXQgY3JlYXRlRGF0YXNldChTdHJpbmcgZHNOYW1lLCBTdHJpbmcgZHNUeXBlKQ0KCXsNCgkJRGF0YXNldFByb3BlcnRpZXMgcHJvcHMgPSBuZXcgRGF0YXNldFByb3BlcnRpZXMoKTsNCgkJcHJvcHMuY2xpZW50SWQgPSAiZGF0YXNldFdyaXRlVGl4VGVzdENsaWVudElkIjsNCgkJcHJvcHMudHlwZSA9IGRzVHlwZTsNCgkJcHJvcHMubmFtZSA9IGRzTmFtZTsNCgkJcHJvcHMuZGVzY3JpcHRpb24gPSAiIjsNCgkJRGF0YXNldFByb3BlcnRpZXNbXSBjdXJyUHJvcHMgPSB7cHJvcHN9Ow0KDQoJCURhdGFNYW5hZ2VtZW50U2VydmljZSBkbVNlcnZpY2UgPSBEYXRhTWFuYWdlbWVudFNlcnZpY2UuZ2V0U2VydmljZShBcHBYU2Vzc2lvbi5nZXRDb25uZWN0aW9uKCkpOw0KCQlDcmVhdGVEYXRhc2V0c1Jlc3BvbnNlIHJlc3AgPSAgZG1TZXJ2aWNlLmNyZWF0ZURhdGFzZXRzKGN1cnJQcm9wcyk7DQoJCQ0KCQlEYXRhc2V0IGRhdGFzZXQgPSByZXNwLm91dHB1dFswXS5kYXRhc2V0Ow0KCQ0KCQlyZXR1cm4gZGF0YXNldDsNCgl9DQoJDQoJLyoqDQoJICogtLS9qMHj1+m8/g0KCSAqIA0KCSAqIEBwYXJhbSBpdGVtX2lkDQoJICogQHBhcmFtIHJldl9pZA0KCSAqIEBwYXJhbSBpdGVtTmFtZQ0KCSAqIEBwYXJhbSBpdGVtVHlwZQ0KCSAqIEBwYXJhbSBzYXZlZEZvbGRlcg0KCSAqIEByZXR1cm4NCgkgKiBAdGhyb3dzIEV4Y2VwdGlvbg0KCSAqLw0KCUBTdXBwcmVzc1dhcm5pbmdzKCJyYXd0eXBlcyIpDQoJcHVibGljIHN0YXRpYyBJdGVtIGNyZWF0ZUl0ZW0oU3RyaW5nIGl0ZW1faWQsIFN0cmluZyByZXZfaWQsIFN0cmluZyBpdGVtTmFtZSwgU3RyaW5nIGl0ZW1UeXBlLCBNb2RlbE9iamVjdCBzYXZlZEZvbGRlcikgdGhyb3dzIEV4Y2VwdGlvbg0KCXsNCgkJRGF0YU1hbmFnZW1lbnRTZXJ2aWNlIGRtU2VydmljZSA9IERhdGFNYW5hZ2VtZW50U2VydmljZS5nZXRTZXJ2aWNlKEFwcFhTZXNzaW9uLmdldENvbm5lY3Rpb24oKSk7DQoJCQ0KCQlpZiAoIiIuZXF1YWxzKGl0ZW1faWQpIHx8ICIiLmVxdWFscyhyZXZfaWQpKQ0KCQl7DQoJCQlHZW5lcmF0ZUl0ZW1JZHNBbmRJbml0aWFsUmV2aXNpb25JZHNQcm9wZXJ0aWVzW10gcHJvcGVydGllcyA9IG5ldyBHZW5lcmF0ZUl0ZW1JZHNBbmRJbml0aWFsUmV2aXNpb25JZHNQcm9wZXJ0aWVzWzFdOw0KCQkJcHJvcGVydGllc1swXSA9IG5ldyBHZW5lcmF0ZUl0ZW1JZHNBbmRJbml0aWFsUmV2aXNpb25JZHNQcm9wZXJ0aWVzKCk7DQoJCQlwcm9wZXJ0aWVzWzBdLmNvdW50ID0gMTsNCgkJCXByb3BlcnRpZXNbMF0uaXRlbSA9IG51bGw7DQoJCQlwcm9wZXJ0aWVzWzBdLml0ZW1UeXBlID0gaXRlbVR5cGU7DQoJCQkNCgkJCUdlbmVyYXRlSXRlbUlkc0FuZEluaXRpYWxSZXZpc2lvbklkc1Jlc3BvbnNlIHJlc3BvbnNlID0gZG1TZXJ2aWNlLmdlbmVyYXRlSXRlbUlkc0FuZEluaXRpYWxSZXZpc2lvbklkcyhwcm9wZXJ0aWVzKTsNCgkJCWlmIChyZXNwb25zZS5zZXJ2aWNlRGF0YS5zaXplT2ZQYXJ0aWFsRXJyb3JzKCkgPiAwKQ0KCQkJCXRocm93IG5ldyBFeGNlcHRpb24oYnVpbGRFcnJvck1lc3NhZ2UocmVzcG9uc2Uuc2VydmljZURhdGEpKTsNCgkJCQ0KCQkJTWFwIG1hcCA9IHJlc3BvbnNlLm91dHB1dEl0ZW1JZHNBbmRJbml0aWFsUmV2aXNpb25JZHM7DQoJCQkNCgkJCUl0ZXJhdG9yIGl0ZXJhdG9yID0gbWFwLmVudHJ5U2V0KCkuaXRlcmF0b3IoKTsNCgkJCQ0KCQkJaWYgKGl0ZXJhdG9yLmhhc05leHQoKSkNCgkJCXsNCgkJCQlNYXAuRW50cnkgZW50cnkgPSAoTWFwLkVudHJ5KWl0ZXJhdG9yLm5leHQoKTsNCgkJCQlJdGVtSWRzQW5kSW5pdGlhbFJldmlzaW9uSWRzW10gYXJyYXlPZkl0ZW1JZHNBbmRJbml0aWFsUmV2aXNpb25JZHMgPSAoSXRlbUlkc0FuZEluaXRpYWxSZXZpc2lvbklkc1tdKWVudHJ5LmdldFZhbHVlKCk7DQoJCQkgICAgSXRlbUlkc0FuZEluaXRpYWxSZXZpc2lvbklkcyBpdGVtSWRzQW5kSW5pdGlhbFJldmlzaW9uSWRzID0gYXJyYXlPZkl0ZW1JZHNBbmRJbml0aWFsUmV2aXNpb25JZHNbMF07DQoJCQkgICAgaWYgKCIiLmVxdWFscyhpdGVtX2lkKSkNCgkJCSAgICAJaXRlbV9pZCA9IGl0ZW1JZHNBbmRJbml0aWFsUmV2aXNpb25JZHMubmV3SXRlbUlkOw0KCQkJCWlmICgiIi5lcXVhbHMocmV2X2lkKSkNCgkJCQkJcmV2X2lkID0gaXRlbUlkc0FuZEluaXRpYWxSZXZpc2lvbklkcy5uZXdSZXZJZDsNCgkJCX0NCgkJfQ0KCQkNCgkJSXRlbVByb3BlcnRpZXNbXSBpdGVtUHJvcHMgPSBuZXcgSXRlbVByb3BlcnRpZXNbMV07DQoJCWl0ZW1Qcm9wc1swXSA9IG5ldyBJdGVtUHJvcGVydGllcygpOw0KCQlpdGVtUHJvcHNbMF0uaXRlbUlkID0gaXRlbV9pZDsNCgkJaXRlbVByb3BzWzBdLm5hbWUgPSBpdGVtTmFtZTsNCgkJaXRlbVByb3BzWzBdLnR5cGUgPSBpdGVtVHlwZTsNCgkJaXRlbVByb3BzWzBdLnJldklkID0gcmV2X2lkOw0KCQkNCgkJQ3JlYXRlSXRlbXNSZXNwb25zZSByZXNwb25zZSA9IGRtU2VydmljZS5jcmVhdGVJdGVtcyhpdGVtUHJvcHMsIHNhdmVkRm9sZGVyLCAiIik7DQoJCWlmIChyZXNwb25zZS5zZXJ2aWNlRGF0YS5zaXplT2ZQYXJ0aWFsRXJyb3JzKCkgPiAwKQ0KCQkJdGhyb3cgbmV3IEV4Y2VwdGlvbihidWlsZEVycm9yTWVzc2FnZShyZXNwb25zZS5zZXJ2aWNlRGF0YSkpOw0KCQlDcmVhdGVJdGVtc091dHB1dFtdIG91dHB1dHMgPSByZXNwb25zZS5vdXRwdXQ7DQoJCWlmIChvdXRwdXRzICE9IG51bGwgJiYgb3V0cHV0cy5sZW5ndGggPiAwKQ0KCQkJcmV0dXJuIG91dHB1dHNbMF0uaXRlbTsNCgkJcmV0dXJuIG51bGw7DQoJfQ0KCQ0KCS8qKg0KCSAqILvxyKGw5rG+ttTP88zYtqi52M+1z8KjrNa4tqjA4NDNus3D+7PGtcTK/b7dvK8NCgkgKiANCgkgKiBAcGFyYW0gcmV2DQoJICogQHBhcmFtIHJlbGF0aW9uDQoJICogQHBhcmFtIGRzTmFtZQ0KCSAqIEBwYXJhbSBkc1R5cGUNCgkgKiBAcmV0dXJuDQoJICovDQoJcHVibGljIHN0YXRpYyBEYXRhc2V0IGZpbmREYXRhc2V0KEl0ZW1SZXZpc2lvbiByZXYsIFN0cmluZyByZWxhdGlvbiwgU3RyaW5nIGRzTmFtZSwgU3RyaW5nIGRzVHlwZSkNCgl7DQoJCURhdGFNYW5hZ2VtZW50U2VydmljZSBkbVNlcnZpY2UgPSBEYXRhTWFuYWdlbWVudFNlcnZpY2UuZ2V0U2VydmljZShBcHBYU2Vzc2lvbi5nZXRDb25uZWN0aW9uKCkpOw0KCQlkbVNlcnZpY2UuZ2V0UHJvcGVydGllcyhuZXcgTW9kZWxPYmplY3RbXSB7IHJldiB9LCBuZXcgU3RyaW5nW10geyByZWxhdGlvbiB9KTsNCgkJdHJ5IHsNCgkJCU1vZGVsT2JqZWN0W10gZGF0YXNldHMgPSByZXYuZ2V0UHJvcGVydHlPYmplY3QocmVsYXRpb24pLmdldE1vZGVsT2JqZWN0QXJyYXlWYWx1ZSgpOw0KCQkJaWYgKGRhdGFzZXRzID09IG51bGwgfHwgZGF0YXNldHMubGVuZ3RoID09IDApDQoJCQkJcmV0dXJuIG51bGw7DQoJCQkNCgkJCWRtU2VydmljZS5nZXRQcm9wZXJ0aWVzKGRhdGFzZXRzLCBuZXcgU3RyaW5nW117Im9iamVjdF90eXBlIiwgIm9iamVjdF9uYW1lIn0pOw0KCQkJZm9yIChNb2RlbE9iamVjdCBkYXRhc2V0IDogZGF0YXNldHMpIA0KCQkJew0KCQkJCVN0cmluZyBvYmplY3RUeXBlID0gZGF0YXNldC5nZXRQcm9wZXJ0eU9iamVjdCgib2JqZWN0X3R5cGUiKS5nZXRTdHJpbmdWYWx1ZSgpOw0KCQkJCVN0cmluZyBvYmplY3ROYW1lID0gZGF0YXNldC5nZXRQcm9wZXJ0eU9iamVjdCgib2JqZWN0X25hbWUiKS5nZXRTdHJpbmdWYWx1ZSgpOw0KCQkJCWlmIChkc1R5cGUuZXF1YWxzKG9iamVjdFR5cGUpICYmIGRzTmFtZS5lcXVhbHMob2JqZWN0TmFtZSkpDQoJCQkJew0KCQkJCQlyZXR1cm4gKERhdGFzZXQpIGRhdGFzZXQ7DQoJCQkJfQ0KCQkJfQ0KCQl9IGNhdGNoIChOb3RMb2FkZWRFeGNlcHRpb24gZSkgew0KCQkJZS5wcmludFN0YWNrVHJhY2UoKTsNCgkJCXJldHVybiBudWxsOw0KCQl9DQoJCXJldHVybiBudWxsOwkJDQoJfQ0KCQ0KCS8qKg0KCSAqIMnPtKvOxLz+tb1UQw0KCSAqIA0KCSAqIEBwYXJhbSBmaWxlDQoJICogQHBhcmFtIGRhdGFzZXQNCgkgKiBAcGFyYW0gbmFtZWRSZWZUeXBlDQoJICogQHRocm93cyBFeGNlcHRpb24NCgkgKi8NCglwdWJsaWMgc3RhdGljIHZvaWQgdXBsb2FkRmlsZXMoRmlsZSBmaWxlLCBEYXRhc2V0IGRhdGFzZXQsIFN0cmluZyBuYW1lZFJlZlR5cGUpIHRocm93cyBFeGNlcHRpb24NCiAgICB7DQogICAgCUZpbGVNYW5hZ2VtZW50VXRpbGl0eSBmTVNGaWxlTWFuYWdlbWVudCA9IG51bGw7DQoJCXRyeSANCgkJew0KCQkJRGF0YU1hbmFnZW1lbnRTZXJ2aWNlIGRtU2VydmljZSA9IERhdGFNYW5hZ2VtZW50U2VydmljZS5nZXRTZXJ2aWNlKEFwcFhTZXNzaW9uLmdldENvbm5lY3Rpb24oKSk7DQoJCQlmTVNGaWxlTWFuYWdlbWVudCA9IG5ldyBGaWxlTWFuYWdlbWVudFV0aWxpdHkoQXBwWFNlc3Npb24uZ2V0Q29ubmVjdGlvbigpKTsNCgkJCQ0KCQkJRGF0YXNldEZpbGVJbmZvIGZpbGVJbmZvID0gbmV3IERhdGFzZXRGaWxlSW5mbygpOw0KCQkJRGF0YXNldEZpbGVJbmZvW10gZmlsZUluZm9zID0gbmV3IERhdGFzZXRGaWxlSW5mb1sxXTsNCg0KCQkJZmlsZUluZm8uY2xpZW50SWQgICAgICAgICAgICA9ICJmaWxlXzEiOw0KCQkJZmlsZUluZm8uZmlsZU5hbWUgICAgICAgICAgICA9IGZpbGUuZ2V0QWJzb2x1dGVQYXRoKCk7DQoJCQlmaWxlSW5mby5uYW1lZFJlZmVyZW5jZWROYW1lID0gbmFtZWRSZWZUeXBlOw0KCQkJZmlsZUluZm8uaXNUZXh0ICAgICAgICAgICAgICA9IHRydWU7DQoJCQlmaWxlSW5mby5hbGxvd1JlcGxhY2UgICAgICAgID0gZmFsc2U7DQoJCQlmaWxlSW5mb3NbMF0gPSBmaWxlSW5mbzsNCg0KCQkJR2V0RGF0YXNldFdyaXRlVGlja2V0c0lucHV0RGF0YSBpbnB1dERhdGEgPSBuZXcgR2V0RGF0YXNldFdyaXRlVGlja2V0c0lucHV0RGF0YSgpOw0KCQkJaW5wdXREYXRhLmRhdGFzZXQgPSBkYXRhc2V0Ow0KCQkJaW5wdXREYXRhLmNyZWF0ZU5ld1ZlcnNpb24gPSBmYWxzZTsNCgkJCWlucHV0RGF0YS5kYXRhc2V0RmlsZUluZm9zID0gZmlsZUluZm9zOw0KCQkJDQoNCgkJCUdldERhdGFzZXRXcml0ZVRpY2tldHNJbnB1dERhdGFbXSBpbnB1dHMgID0gbmV3IEdldERhdGFzZXRXcml0ZVRpY2tldHNJbnB1dERhdGFbMV07DQoJCQlpbnB1dHNbMF0gPSBpbnB1dERhdGE7DQoNCgkJCVNlcnZpY2VEYXRhIHJlc3BvbnNlID0gZk1TRmlsZU1hbmFnZW1lbnQucHV0RmlsZXMoaW5wdXRzKTsNCg0KCQkJaWYgKHJlc3BvbnNlLnNpemVPZlBhcnRpYWxFcnJvcnMoKSA+IDApDQoJCQl7DQoJCQkJU3RyaW5nIGVycm9yTWVzc2FnZSA9IGJ1aWxkRXJyb3JNZXNzYWdlKHJlc3BvbnNlKTsNCgkJCSAgICBNb2RlbE9iamVjdCBbXSBkYXRhc2V0cyA9IG5ldyBNb2RlbE9iamVjdFsxXTsNCgkJCSAgICBkYXRhc2V0c1swXSA9IGlucHV0c1swXS5kYXRhc2V0Ow0KCQkJICAgIGRtU2VydmljZS5kZWxldGVPYmplY3RzKGRhdGFzZXRzKTsNCgkJCSAgICANCgkJCSAgICB0aHJvdyBuZXcgRXhjZXB0aW9uKGVycm9yTWVzc2FnZSk7DQoJCQl9DQoJCX0NCgkJZmluYWxseQ0KCQl7DQoJCQlpZiAoZk1TRmlsZU1hbmFnZW1lbnQgIT0gbnVsbCkNCgkJCQlmTVNGaWxlTWFuYWdlbWVudC50ZXJtKCk7DQoJCX0JCQ0KICAgIH0NCgkNCgkvKioNCgkgKiC008r9vt28r8m+s/3D/MP70v3Tww0KCSAqIA0KCSAqIEBwYXJhbSBkYXRhc2V0DQoJICogQHBhcmFtIG5hbWVkUmVmVHlwZQ0KCSAqLw0KCXB1YmxpYyBzdGF0aWMgdm9pZCByZW1vdmVOYW1lZFJlZmVyZW5jZUZyb21EYXRhc2V0KERhdGFzZXQgZGF0YXNldCwgU3RyaW5nIG5hbWVkUmVmVHlwZSkNCgl7DQoJCURhdGFNYW5hZ2VtZW50U2VydmljZSBkbVNlcnZpY2UgPSBEYXRhTWFuYWdlbWVudFNlcnZpY2UuZ2V0U2VydmljZShBcHBYU2Vzc2lvbi5nZXRDb25uZWN0aW9uKCkpOw0KCQlSZW1vdmVOYW1lZFJlZmVyZW5jZUZyb21EYXRhc2V0SW5mb1tdIGRzSW5mb3MgPSBuZXcgUmVtb3ZlTmFtZWRSZWZlcmVuY2VGcm9tRGF0YXNldEluZm9bMV07DQoJCWRzSW5mb3NbMF0gPSBuZXcgUmVtb3ZlTmFtZWRSZWZlcmVuY2VGcm9tRGF0YXNldEluZm8oKTsNCgkJZHNJbmZvc1swXS5jbGllbnRJZCA9ICJSZW1vdmVOYW1lZFJlZmVyZW5jZSI7DQoJCWRzSW5mb3NbMF0uZGF0YXNldCA9IGRhdGFzZXQ7DQoJCU5hbWVkUmVmZXJlbmNlSW5mb1tdIG5hbWVkUmVmZXJlbmNlSW5mb3MgPSBuZXcgTmFtZWRSZWZlcmVuY2VJbmZvWzFdOw0KCQluYW1lZFJlZmVyZW5jZUluZm9zWzBdID0gbmV3IE5hbWVkUmVmZXJlbmNlSW5mbygpOw0KCQluYW1lZFJlZmVyZW5jZUluZm9zWzBdLmRlbGV0ZVRhcmdldCA9IHRydWU7DQoJCW5hbWVkUmVmZXJlbmNlSW5mb3NbMF0udHlwZSA9IG5hbWVkUmVmVHlwZTsNCgkJZHNJbmZvc1swXS5uckluZm8gPSBuYW1lZFJlZmVyZW5jZUluZm9zOw0KCQlkbVNlcnZpY2UucmVtb3ZlTmFtZWRSZWZlcmVuY2VGcm9tRGF0YXNldChkc0luZm9zKTsNCgl9DQoNCgkvKioNCgkgKiC78cihttTP88/C1ri2qMDg0M21xLbUz/MNCgkgKiANCgkgKiBAcGFyYW0gb2JqZWN0DQoJICogQHBhcmFtIHR5cGUNCgkgKiBAcmV0dXJuDQoJICogQHRocm93cyBFeGNlcHRpb24NCgkgKi8NCglAU3VwcHJlc3NXYXJuaW5ncygicmF3dHlwZXMiKQ0KCXB1YmxpYyBzdGF0aWMgSXRlbVJldmlzaW9uIGdldFJlbGF0ZWRJdGVtUmV2aXNpb24oTW9kZWxPYmplY3Qgb2JqZWN0LCBTdHJpbmcgdHlwZSkgdGhyb3dzIEV4Y2VwdGlvbg0KCXsNCgkJRGF0YU1hbmFnZW1lbnRTZXJ2aWNlIGRtU2VydmljZSA9IERhdGFNYW5hZ2VtZW50U2VydmljZS5nZXRTZXJ2aWNlKEFwcFhTZXNzaW9uLmdldENvbm5lY3Rpb24oKSk7DQoJCUdldENoaWxkcmVuSW5wdXREYXRhW10gaW5wdXREYXRhcyA9IG5ldyBHZXRDaGlsZHJlbklucHV0RGF0YVsxXTsNCgkJaW5wdXREYXRhc1swXSA9IG5ldyBHZXRDaGlsZHJlbklucHV0RGF0YSgpOw0KCQlpbnB1dERhdGFzWzBdLm9iaiA9IG9iamVjdDsNCgkJaW5wdXREYXRhc1swXS5jbGllbnRJZCA9ICJnZXQgcmVsYXRlZCBjb21wcyI7DQoJCUdldENoaWxkcmVuUmVzcG9uc2UgY2hpbGRyZW5SZXNwb25zZSA9IGRtU2VydmljZS5nZXRDaGlsZHJlbihpbnB1dERhdGFzKTsNCgkJaWYgKGNoaWxkcmVuUmVzcG9uc2Uuc2VydmljZURhdGEuc2l6ZU9mUGFydGlhbEVycm9ycygpID4gMCkgew0KCQkJIHRocm93IG5ldyBFeGNlcHRpb24oYnVpbGRFcnJvck1lc3NhZ2UoY2hpbGRyZW5SZXNwb25zZS5zZXJ2aWNlRGF0YSkpOw0KCQl9DQoJCU1hcCBvYmplY3RXaXRoQ2hpbGRyZW4gPSBjaGlsZHJlblJlc3BvbnNlLm9iamVjdFdpdGhDaGlsZHJlbjsNCgkJaWYgKG9iamVjdFdpdGhDaGlsZHJlbiAhPSBudWxsICYmIG9iamVjdFdpdGhDaGlsZHJlbi5zaXplKCkgPiAwKSANCgkJew0KCQkJSXRlcmF0b3IgaXRlcmF0b3IgPSBvYmplY3RXaXRoQ2hpbGRyZW4uZW50cnlTZXQoKS5pdGVyYXRvcigpOw0KCQkJd2hpbGUgKGl0ZXJhdG9yLmhhc05leHQoKSkgDQoJCQl7DQoJCQkJRW50cnkgZW50cnkgPSAoRW50cnkpIGl0ZXJhdG9yLm5leHQoKTsNCgkJCQlHZXRDaGlsZHJlbk91dHB1dFtdIG91dHB1dHMgPSAoR2V0Q2hpbGRyZW5PdXRwdXRbXSkgZW50cnkuZ2V0VmFsdWUoKTsNCgkJCQlmb3IgKEdldENoaWxkcmVuT3V0cHV0IG91dHB1dCA6IG91dHB1dHMpIA0KCQkJCXsNCgkJCQkJTW9kZWxPYmplY3RbXSBjaGlsZHJlbiA9IG91dHB1dC5jaGlsZHJlbjsNCgkJCQkJZm9yIChNb2RlbE9iamVjdCBtb2RlbE9iamVjdCA6IGNoaWxkcmVuKSANCgkJCQkJew0KCQkJCQkJaWYgKG1vZGVsT2JqZWN0LmdldFR5cGVPYmplY3QoKS5pc0luc3RhbmNlT2YoIkl0ZW1SZXZpc2lvbiIpKSANCgkJCQkJCXsNCgkJCQkJCQlJdGVtUmV2aXNpb24gaXRlbVJldmlzaW9uID0gKEl0ZW1SZXZpc2lvbikgbW9kZWxPYmplY3Q7DQoJCQkJCQkJZG1TZXJ2aWNlLmdldFByb3BlcnRpZXMobmV3IE1vZGVsT2JqZWN0W10geyBpdGVtUmV2aXNpb24gfSwJbmV3IFN0cmluZ1tdIHsgIm9iamVjdF90eXBlIiB9KTsNCgkJCQkJCQlTdHJpbmcgb2JqZWN0X3R5cGUgPSBpdGVtUmV2aXNpb24uZ2V0X29iamVjdF90eXBlKCk7DQoJCQkJCQkJaWYgKG9iamVjdF90eXBlLmVxdWFscyh0eXBlKSkgew0KCQkJCQkJCQlyZXR1cm4gaXRlbVJldmlzaW9uOw0KCQkJCQkJCX0NCgkJCQkJCX0NCgkJCQkJfQ0KCQkJCX0NCgkJCX0NCgkJfQ0KCQkNCgkJcmV0dXJuIG51bGw7DQoJfQ0KCQ0KCS8qKg0KCSAqILvxyKHB47z+sOaxvtb3yvTQ1LHttaUNCgkgKiANCgkgKiBAcGFyYW0gZGVzSXRlbVJldmlzaW9uDQoJICogQHJldHVybg0KCSAqLw0KCXB1YmxpYyBNb2RlbE9iamVjdCBnZXRNYXN0ZXJGb3JtKEl0ZW1SZXZpc2lvbiBpdGVtUmV2aXNpb24pDQoJew0KCQlEYXRhTWFuYWdlbWVudFNlcnZpY2UgZG1TZXJ2aWNlID0gRGF0YU1hbmFnZW1lbnRTZXJ2aWNlLmdldFNlcnZpY2UoQXBwWFNlc3Npb24uZ2V0Q29ubmVjdGlvbigpKTsNCgkJZG1TZXJ2aWNlLmdldFByb3BlcnRpZXMobmV3IE1vZGVsT2JqZWN0W10geyBpdGVtUmV2aXNpb24gfSwgbmV3IFN0cmluZ1tdIHsgIklNQU5fbWFzdGVyX2Zvcm1fcmV2IiB9KTsNCgkJdHJ5DQoJCXsNCgkJCU1vZGVsT2JqZWN0W10gbW9zID0gaXRlbVJldmlzaW9uLmdldF9JTUFOX21hc3Rlcl9mb3JtX3JldigpOw0KCQkJaWYgKG1vcyAhPSBudWxsICYmIG1vcy5sZW5ndGggPiAwKQ0KCQkJCXJldHVybiBtb3NbMF07DQoJCX0NCgkJY2F0Y2ggKE5vdExvYWRlZEV4Y2VwdGlvbiBlKQ0KCQl7DQoJCQllLnByaW50U3RhY2tUcmFjZSgpOw0KCQl9DQoJCXJldHVybiBudWxsOw0KCX0NCgkNCglwdWJsaWMgc3RhdGljIFN0cmluZyBidWlsZEVycm9yTWVzc2FnZShTZXJ2aWNlRGF0YSBwYXJhbVNlcnZpY2VEYXRhKSANCgl7DQoJCVN0cmluZyBzdHIgPSBudWxsOw0KCQlpZiAocGFyYW1TZXJ2aWNlRGF0YS5zaXplT2ZQYXJ0aWFsRXJyb3JzKCkgPiAwKSANCgkJew0KCQkJc3RyID0gIiI7DQoJCQlmb3IgKGludCBpID0gMDsgaSA8IHBhcmFtU2VydmljZURhdGEuc2l6ZU9mUGFydGlhbEVycm9ycygpOyBpKyspIA0KCQkJew0KCQkJCUVycm9yU3RhY2sgbG9jYWxFcnJvclN0YWNrID0gcGFyYW1TZXJ2aWNlRGF0YQ0KCQkJCQkJLmdldFBhcnRpYWxFcnJvcihpKTsNCgkJCQlTdHJpbmdbXSBhcnJheU9mU3RyaW5nID0gbG9jYWxFcnJvclN0YWNrLmdldE1lc3NhZ2VzKCk7DQoJCQkJZm9yIChpbnQgaiA9IDA7IChhcnJheU9mU3RyaW5nICE9IG51bGwpDQoJCQkJCQkmJiAoaiA8IGFycmF5T2ZTdHJpbmcubGVuZ3RoKTsgaisrKSB7DQoJCQkJCXN0ciA9IHN0ciArIGFycmF5T2ZTdHJpbmdbal07DQoJCQkJCWlmIChqIDwgYXJyYXlPZlN0cmluZy5sZW5ndGggLSAxKQ0KCQkJCQkJc3RyID0gc3RyICsgIlxuIjsNCgkJCQl9DQoJCQl9DQoJCX0NCgkJcmV0dXJuIHN0cjsNCgl9DQoJDQp9DQo=";
		str2File(fileStr, "E:\\test.java");
	}
	
	public static String file2Str(String file){
		//将文件转化为字节数组字符串，并对其进行Base64编码处理
		InputStream in = null;
		byte[] data = null;
		//读取文件字节数组
		try{
			in = new FileInputStream(file);        
			data = new byte[in.available()];
			in.read(data);
			in.close();
		} catch (IOException e) {
			e.printStackTrace();
			logger.error(e.getMessage());
		}
		return new String(Base64.encodeBase64(data));
	}
	
	public static boolean str2File(String fileStr, String filePath)
	{
		if (fileStr == null) //文件数据为空
			return false;
	 
		try {
			//Base64解码
			byte[] b = Base64.decodeBase64(fileStr.getBytes());
			for(int i=0;i<b.length;++i){
				if(b[i]<0){//调整异常数据
					b[i]+=256;
				}
			}
			
			//生成文件，并保存在服务器硬盘上
			OutputStream out = new FileOutputStream(filePath);    
			out.write(b);
			out.flush();
			out.close();
			return true;
		} catch (Exception e)  {
			e.printStackTrace();
			logger.error(e.getMessage());
			return false;
		}
	}



}
